<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="icon" href="data:,">  <!-- ç©ºå›¾æ ‡ -->
</head>
<body>
    <script>
        const PENDING = 'pending';
        const FULFILLED = 'fulfilled';
        const REJECTED = 'rejected';
        class MyPromise{
            #promiseState = PENDING;
            #promiseResult = null;

            #handlerList = [];
            constructor(executor) {
                try {
                    executor(this.resolve.bind(this), this.reject.bind(this));
                } catch(err) {
                    this.reject(err);
                }
            }
            changeState(state, result) {
                if (this.#promiseState !== PENDING) return;
                this.#promiseState = state;
                this.#promiseResult = result;                
                
                if(this.#handlerList.length) {
                    const {onFulfilled, onRejected, resolve, reject} = this.handlerList.shift();
                    if (this.#promiseState === FULFILLED) {
                        const data = onFulfilled(this.#promiseResult)
                        resolve(data);
                    } else if (this.#promiseState === REJECTED) {
                        const data = onRejected(this.#promiseResult);
                        resolve(data);
                    }
                }
            }
            resolve(res) {
                this.changeState(FULFILLED, res);
            }
            reject(err) {
                this.changeState(REJECTED, err);
            }
            // æˆåŠŸçŠ¶æ€è§¦å‘æˆåŠŸå›è°ƒï¼Œå¤±è´¥çŠ¶æ€è§¦å‘å¤±è´¥å›è°ƒã€‚
            then(onFulfilled, onRejected) {
                // console.log("ğŸš€ ~ MyPromise ~ then ~ onRejected:", onRejected)
                // console.log("ğŸš€ ~ MyPromise ~ then ~ onFulfilled:", onFulfilled)
                return new Promise((resolve, reject) => {
                    if (this.#promiseState === FULFILLED) {
                        const data = onFulfilled(this.#promiseResult)
                        resolve(data);
                    } else if (this.#promiseState === REJECTED) {
                        const data = onRejected(this.#promiseResult)
                        resolve(data);
                    } else {
                        // éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œæ‰æœ‰ç»“æœ => ç­‰çŠ¶æ€æ”¹å˜å†æ‰§è¡Œè¿™é‡Œçš„å›è°ƒ
                        this.#handlerList.push({
                            onFulfilled,
                            onRejected,
                            resolve,
                            reject
                        })
                    }
                })
            }
        }
        
        const p = new Promise((resolve, reject) => {
            resolve(111);
        }).then(res => {
            console.log(res, '1');
            return res;
        }, 232).then(res => {
            setTimeout(() => {
                console.log(res, '2');
                return res;
            }, 1000)
        }).then(res => {
            setTimeout(() => {
                console.log(res, '3');            
            }, 2000);
        })
        // return new MyPromise((resolve, reject) => {
        //     setTimeout(() => {
        //         resolve(res);
        //     })
        // });
        
        // character å½“ä¸º true æ—¶ï¼Œç›‘å¬å£°æ˜çš„ target èŠ‚ç‚¹ä¸Šæ‰€æœ‰å­—ç¬¦çš„å˜åŒ–ã€‚
    </script>
</body>
</html>